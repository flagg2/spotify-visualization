<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CZ Artist Collaboration Network</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #0a0a0a;
        color: #ffffff;
        overflow: hidden;
      }

      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      h1 {
        position: absolute;
        top: 20px;
        left: 20px;
        color: #1db954;
        margin: 0;
        z-index: 10;
        font-size: 28px;
      }

      .subtitle {
        position: absolute;
        top: 60px;
        left: 20px;
        color: #b3b3b3;
        z-index: 10;
        font-size: 14px;
      }

      #stats {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(40, 40, 40, 0.95);
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10;
        font-size: 13px;
        line-height: 1.6;
      }

      #controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background-color: rgba(40, 40, 40, 0.95);
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10;
      }

      .control-group {
        margin: 10px 0;
      }

      label {
        color: #b3b3b3;
        margin-right: 10px;
        display: inline-block;
        width: 140px;
      }

      input[type="range"] {
        width: 150px;
        vertical-align: middle;
      }

      input[type="checkbox"] {
        margin-right: 5px;
      }

      input[type="text"] {
        background-color: #191414;
        color: #ffffff;
        border: 1px solid #535353;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 13px;
        width: 200px;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #1db954;
      }

      #searchSuggestions {
        position: absolute;
        background-color: #191414;
        border: 1px solid #1db954;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        margin-top: 2px;
      }

      .search-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        color: #ffffff;
        font-size: 13px;
      }

      .search-suggestion:hover {
        background-color: #1db954;
      }

      .search-suggestion-highlight {
        color: #1db954;
        font-weight: bold;
      }

      select {
        background-color: #191414;
        color: #ffffff;
        border: 1px solid #535353;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 13px;
      }

      .value-display {
        display: inline-block;
        color: #1db954;
        min-width: 30px;
        text-align: right;
      }

      #legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background-color: rgba(40, 40, 40, 0.95);
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10;
        max-width: 250px;
      }

      .legend-title {
        font-weight: bold;
        color: #1db954;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .legend-item {
        font-size: 12px;
        color: #b3b3b3;
        margin: 5px 0;
        line-height: 1.4;
      }

      svg {
        width: 100%;
        height: 100%;
        cursor: grab;
      }

      svg:active {
        cursor: grabbing;
      }

      .link {
        stroke: #535353;
        stroke-opacity: 0.6;
        fill: none;
      }

      .link.highlighted {
        stroke: #1db954;
        stroke-opacity: 1;
      }

      .node circle {
        stroke: #fff;
        stroke-width: 1.5px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .node:hover circle {
        stroke: #1db954;
        stroke-width: 3px;
      }

      .node.highlighted circle {
        stroke: #1db954;
        stroke-width: 3px;
      }

      .node.dimmed {
        opacity: 0.2;
      }

      .node-label {
        font-size: 11px;
        fill: #ffffff;
        text-anchor: middle;
        pointer-events: none;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
      }

      .tooltip {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.95);
        border: 2px solid #1db954;
        border-radius: 8px;
        padding: 15px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        max-width: 300px;
        font-size: 13px;
        z-index: 1000;
      }

      .tooltip-artist {
        font-size: 18px;
        font-weight: bold;
        color: #1db954;
        margin-bottom: 10px;
      }

      .tooltip-stats {
        color: #b3b3b3;
        line-height: 1.8;
      }

      .tooltip-label {
        color: #ffffff;
        font-weight: 500;
      }

      .tooltip-tracks {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #535353;
      }

      .tooltip-track {
        font-size: 11px;
        color: #b3b3b3;
        margin: 3px 0;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>ðŸŽµ CZ Artist Collaboration Network</h1>
      <p class="subtitle">
        Interactive force-directed graph of Czech music collaborations
      </p>

      <div id="stats">
        <div id="stats-content">Loading...</div>
      </div>

      <div id="controls">
        <div class="control-group">
          <label for="artistSearch">Search Artist:</label>
          <input
            type="text"
            id="artistSearch"
            placeholder="Type artist name..."
          />
          <div id="searchSuggestions"></div>
        </div>
        <div class="control-group">
          <label for="minCollabs">Min Collaborations:</label>
          <input
            type="range"
            id="minCollabs"
            min="0"
            max="10"
            value="0"
            step="1"
          />
          <span class="value-display" id="minCollabsValue">0</span>
        </div>
        <div class="control-group">
          <label for="nodeSize">Node Size:</label>
          <input
            type="range"
            id="nodeSize"
            min="2"
            max="20"
            value="5"
            step="0.5"
          />
          <span class="value-display" id="nodeSizeValue">5</span>
        </div>
        <div class="control-group">
          <label for="linkStrength">Link Strength:</label>
          <input
            type="range"
            id="linkStrength"
            min="0.1"
            max="2"
            value="1"
            step="0.1"
          />
          <span class="value-display" id="linkStrengthValue">1.0</span>
        </div>
        <div class="control-group">
          <label for="chargeStrength">Repulsion:</label>
          <input
            type="range"
            id="chargeStrength"
            min="-500"
            max="-50"
            value="-200"
            step="10"
          />
          <span class="value-display" id="chargeStrengthValue">-200</span>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="showLabels" checked />
            Show Artist Names
          </label>
        </div>
      </div>

      <div id="legend">
        <div class="legend-title">ðŸ’¡ How to Use</div>
        <div class="legend-item">
          â€¢ <strong>Search</strong> for artist to center view
        </div>
        <div class="legend-item">
          â€¢ <strong>Node size</strong> = Number of tracks
        </div>
        <div class="legend-item">
          â€¢ <strong>Node color</strong> = Popularity (red=high)
        </div>
        <div class="legend-item">
          â€¢ <strong>Link thickness</strong> = Collaboration count
        </div>
        <div class="legend-item">
          â€¢ <strong>Hover</strong> over nodes for details
        </div>
        <div class="legend-item">
          â€¢ <strong>Click</strong> to highlight connections
        </div>
        <div class="legend-item">
          â€¢ <strong>Drag</strong> nodes to rearrange
        </div>
        <div class="legend-item">â€¢ <strong>Scroll</strong> to zoom</div>
      </div>

      <svg id="network"></svg>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      // Configuration
      const width = window.innerWidth;
      const height = window.innerHeight;

      // Create SVG with zoom
      const svg = d3.select("#network");
      const g = svg.append("g");

      // Zoom behavior
      const zoom = d3
        .zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", (event) => {
          g.attr("transform", event.transform);
        });

      svg.call(zoom);

      // Tooltip
      const tooltip = d3.select("#tooltip");

      // State
      let selectedNode = null;
      let minCollabs = 0;
      let nodeSizeMultiplier = 5;
      let linkStrengthValue = 1;
      let chargeStrength = -200;
      let showLabels = true;

      // Color scale for popularity
      const colorScale = d3
        .scaleSequential(d3.interpolateRdYlGn)
        .domain([0, 100]);

      // Load data
      d3.json("collab_network.json")
        .then((data) => {
          console.log("Network data loaded:", data);

          // Update stats
          document.getElementById("stats-content").innerHTML = `
                <div><strong>Artists:</strong> ${data.metadata.total_artists}</div>
                <div><strong>Collaborations:</strong> ${data.metadata.total_collaborations}</div>
                <div><strong>Tracks:</strong> ${data.metadata.total_tracks}</div>
            `;

          // Store full data
          const fullData = {
            nodes: data.nodes.map((d) => ({ ...d })),
            links: data.links.map((d) => ({ ...d })),
          };

          // Create force simulation
          let simulation = d3
            .forceSimulation()
            .force(
              "link",
              d3
                .forceLink()
                .id((d) => d.index)
                .distance(100)
            )
            .force("charge", d3.forceManyBody().strength(chargeStrength))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force(
              "collision",
              d3.forceCollide().radius((d) => getNodeRadius(d) + 5)
            );

          // Create link and node groups
          let link = g.append("g").selectAll(".link");
          let node = g.append("g").selectAll(".node");
          let label = g.append("g").selectAll(".node-label");

          function getNodeRadius(d) {
            return Math.sqrt(d.track_count) * nodeSizeMultiplier;
          }

          function getLineWidth(d) {
            return Math.sqrt(d.weight) * 1.5;
          }

          function filterData() {
            // Filter nodes by minimum collaborations
            const filteredNodes = fullData.nodes.filter(
              (d) => d.collaborator_count >= minCollabs
            );
            const nodeIds = new Set(filteredNodes.map((d) => d.index));

            // Filter links to only include filtered nodes
            const filteredLinks = fullData.links.filter(
              (d) =>
                nodeIds.has(d.source.index || d.source) &&
                nodeIds.has(d.target.index || d.target)
            );

            return { nodes: filteredNodes, links: filteredLinks };
          }

          function update() {
            const filteredData = filterData();

            // Update links
            link = link.data(
              filteredData.links,
              (d) =>
                `${d.source.index || d.source}-${d.target.index || d.target}`
            );
            link.exit().remove();
            link = link
              .enter()
              .append("line")
              .attr("class", "link")
              .merge(link)
              .attr("stroke-width", getLineWidth);

            // Update nodes
            node = node.data(filteredData.nodes, (d) => d.index);
            node.exit().remove();

            const nodeEnter = node
              .enter()
              .append("g")
              .attr("class", "node")
              .call(
                d3
                  .drag()
                  .on("start", dragstarted)
                  .on("drag", dragged)
                  .on("end", dragended)
              );

            nodeEnter.append("circle");

            node = nodeEnter.merge(node);

            node
              .select("circle")
              .attr("r", getNodeRadius)
              .attr("fill", (d) => colorScale(d.avg_popularity));

            node
              .on("mouseover", function (event, d) {
                d3.select(this).classed("highlighted", true);

                const topTracks = d.top_tracks
                  .map(
                    (t) =>
                      `<div class="tooltip-track">â€¢ ${t.name} (${t.popularity})</div>`
                  )
                  .join("");

                tooltip
                  .style("opacity", 1)
                  .html(
                    `
                            <div class="tooltip-artist">${d.id}</div>
                            <div class="tooltip-stats">
                                <div><span class="tooltip-label">Tracks:</span> ${d.track_count}</div>
                                <div><span class="tooltip-label">Avg Popularity:</span> ${d.avg_popularity}</div>
                                <div><span class="tooltip-label">Collaborators:</span> ${d.collaborator_count}</div>
                            </div>
                            <div class="tooltip-tracks">
                                <div style="font-weight: 500; margin-bottom: 5px;">Top Tracks:</div>
                                ${topTracks}
                            </div>
                        `
                  )
                  .style("left", event.pageX + 15 + "px")
                  .style("top", event.pageY - 15 + "px");
              })
              .on("mouseout", function (event, d) {
                if (selectedNode !== d) {
                  d3.select(this).classed("highlighted", false);
                }
                tooltip.style("opacity", 0);
              })
              .on("click", function (event, d) {
                event.stopPropagation();

                if (selectedNode === d) {
                  // Deselect
                  selectedNode = null;
                  node.classed("highlighted", false).classed("dimmed", false);
                  link.classed("highlighted", false);
                } else {
                  // Select and highlight connections
                  selectedNode = d;

                  // Get connected node indices
                  const connectedIndices = new Set();
                  connectedIndices.add(d.index);

                  link.each(function (l) {
                    const sourceIndex = l.source.index || l.source;
                    const targetIndex = l.target.index || l.target;
                    if (sourceIndex === d.index || targetIndex === d.index) {
                      connectedIndices.add(sourceIndex);
                      connectedIndices.add(targetIndex);
                    }
                  });

                  // Highlight/dim nodes
                  node
                    .classed("highlighted", (n) => n.index === d.index)
                    .classed("dimmed", (n) => !connectedIndices.has(n.index));

                  // Highlight connected links
                  link.classed("highlighted", (l) => {
                    const sourceIndex = l.source.index || l.source;
                    const targetIndex = l.target.index || l.target;
                    return sourceIndex === d.index || targetIndex === d.index;
                  });
                }
              });

            // Update labels
            label = label.data(filteredData.nodes, (d) => d.index);
            label.exit().remove();
            label = label
              .enter()
              .append("text")
              .attr("class", "node-label")
              .text((d) => d.id)
              .merge(label)
              .style("display", showLabels ? "block" : "none");

            // Update simulation
            simulation.nodes(filteredData.nodes);
            simulation.force("link").links(filteredData.links);
            simulation.alpha(1).restart();
          }

          simulation.on("tick", () => {
            link
              .attr("x1", (d) => d.source.x)
              .attr("y1", (d) => d.source.y)
              .attr("x2", (d) => d.target.x)
              .attr("y2", (d) => d.target.y);

            node.attr("transform", (d) => `translate(${d.x},${d.y})`);

            label
              .attr("x", (d) => d.x)
              .attr("y", (d) => d.y - getNodeRadius(d) - 5);
          });

          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }

          // Controls
          d3.select("#minCollabs").on("input", function () {
            minCollabs = +this.value;
            d3.select("#minCollabsValue").text(minCollabs);
            update();
          });

          d3.select("#nodeSize").on("input", function () {
            nodeSizeMultiplier = +this.value;
            d3.select("#nodeSizeValue").text(nodeSizeMultiplier.toFixed(1));
            node.select("circle").attr("r", getNodeRadius);
            label.attr("y", (d) => d.y - getNodeRadius(d) - 5);
            simulation.force(
              "collision",
              d3.forceCollide().radius((d) => getNodeRadius(d) + 5)
            );
            simulation.alpha(0.3).restart();
          });

          d3.select("#linkStrength").on("input", function () {
            linkStrengthValue = +this.value;
            d3.select("#linkStrengthValue").text(linkStrengthValue.toFixed(1));
            simulation.force("link").strength(linkStrengthValue);
            simulation.alpha(0.3).restart();
          });

          d3.select("#chargeStrength").on("input", function () {
            chargeStrength = +this.value;
            d3.select("#chargeStrengthValue").text(chargeStrength);
            simulation.force("charge").strength(chargeStrength);
            simulation.alpha(0.3).restart();
          });

          d3.select("#showLabels").on("change", function () {
            showLabels = this.checked;
            label.style("display", showLabels ? "block" : "none");
          });

          // Click on background to deselect
          svg.on("click", () => {
            selectedNode = null;
            node.classed("highlighted", false).classed("dimmed", false);
            link.classed("highlighted", false);
          });

          // Search functionality
          const searchInput = d3.select("#artistSearch");
          const searchSuggestions = d3.select("#searchSuggestions");

          function centerOnArtist(artistData) {
            if (!artistData.x || !artistData.y) return;

            // Calculate transform to center on artist
            const scale = 2; // Zoom level
            const x = width / 2 - artistData.x * scale;
            const y = height / 2 - artistData.y * scale;

            // Animate zoom and pan
            svg
              .transition()
              .duration(750)
              .call(
                zoom.transform,
                d3.zoomIdentity.translate(x, y).scale(scale)
              );

            // Highlight the artist
            setTimeout(() => {
              // Trigger click to highlight connections
              const nodeElement = node
                .filter((d) => d.index === artistData.index)
                .node();
              if (nodeElement) {
                const event = new MouseEvent("click", { bubbles: true });
                nodeElement.dispatchEvent(event);
              }
            }, 800);
          }

          searchInput.on("input", function () {
            const query = this.value.toLowerCase().trim();

            if (query.length === 0) {
              searchSuggestions.style("display", "none");
              return;
            }

            // Find matching artists
            const matches = fullData.nodes
              .filter((d) => d.id.toLowerCase().includes(query))
              .slice(0, 10); // Limit to 10 suggestions

            if (matches.length === 0) {
              searchSuggestions.style("display", "none");
              return;
            }

            // Show suggestions
            searchSuggestions.style("display", "block").html("");

            matches.forEach((artist) => {
              const div = searchSuggestions
                .append("div")
                .attr("class", "search-suggestion")
                .html(() => {
                  // Highlight matching part
                  const index = artist.id.toLowerCase().indexOf(query);
                  if (index === -1) return artist.id;

                  const before = artist.id.substring(0, index);
                  const match = artist.id.substring(
                    index,
                    index + query.length
                  );
                  const after = artist.id.substring(index + query.length);

                  return `${before}<span class="search-suggestion-highlight">${match}</span>${after}`;
                })
                .on("click", () => {
                  searchInput.node().value = artist.id;
                  searchSuggestions.style("display", "none");
                  centerOnArtist(artist);
                });
            });
          });

          // Handle Enter key to select first suggestion
          searchInput.on("keydown", function (event) {
            if (event.key === "Enter") {
              const query = this.value.toLowerCase().trim();
              if (query.length === 0) return;

              const match = fullData.nodes.find(
                (d) =>
                  d.id.toLowerCase() === query ||
                  d.id.toLowerCase().includes(query)
              );

              if (match) {
                searchSuggestions.style("display", "none");
                centerOnArtist(match);
              }
            }

            if (event.key === "Escape") {
              searchSuggestions.style("display", "none");
            }
          });

          // Close suggestions when clicking outside
          d3.select("body").on("click", function (event) {
            if (
              !event.target.closest("#artistSearch") &&
              !event.target.closest("#searchSuggestions")
            ) {
              searchSuggestions.style("display", "none");
            }
          });

          // Initial update
          update();
        })
        .catch((error) => {
          console.error("Error loading data:", error);
          document.getElementById("stats-content").innerHTML =
            '<div style="color: #ff4444;">Error loading network data</div>';
        });
    </script>
  </body>
</html>
